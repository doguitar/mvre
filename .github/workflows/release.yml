name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    name: build (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            asset_ext: zip
          - os: ubuntu-latest
            rid: linux-x64
            asset_ext: tar.gz

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install native toolchain (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang zlib1g-dev

      - name: Publish (Native AOT)
        shell: bash
        run: |
          set -euo pipefail
          dotnet publish "src/mvre.csproj" \
            -c ReleaseAot \
            -r "${{ matrix.rid }}" \
            /p:ContinuousIntegrationBuild=true

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $publishDir = Join-Path $PWD "src/bin/ReleaseAot/net10.0/${{ matrix.rid }}/publish"
          $outDir = Join-Path $PWD "dist"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $zipPath = Join-Path $outDir "mvre-${{ github.ref_name }}-${{ matrix.rid }}.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $publishDir "*") -DestinationPath $zipPath

      - name: Package (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          publish_dir="src/bin/ReleaseAot/net10.0/${{ matrix.rid }}/publish"
          mkdir -p dist
          tar -C "$publish_dir" -czf "dist/mvre-${{ github.ref_name }}-${{ matrix.rid }}.tar.gz" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mvre-${{ matrix.rid }}
          path: dist/*

  release:
    name: create release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List files
        run: ls -R dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/mvre-*.zip
            dist/**/mvre-*.tar.gz
          generate_release_notes: true

